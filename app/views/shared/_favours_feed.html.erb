<% if @favours.length == 0 %>
    <h1>Look's like everyone is sorted, nobody needs something at the moment</h1>
    <h1>All the deadlines must have based, I hope they got help.</h1>
    <h1>Why don't you ask for something?</h1>
<%else%>
    <h1>All Favours Asked...</h1>
    <table class="table table-striped">
      <thead>
      <tr>
        <th>Title</th>
        <th>Deadline</th>
        <th>Distance (km)</th>
        <th>Creator</th>
        <th>Description</th>
      </tr>
      </thead>

      <tbody>
      <% @favours.each do |favour| %>
          <tr>
            <td><%= link_to favour.title, favour %></a></td>
            <td><% if favour.deadline.nil? %>
                  No deadline given
              <% elsif favour.deadline.year >= 2117 %>
                  Literally Whenever
              <% elsif favour.deadline.today? %>
                  Today at <%= favour.deadline.strftime("%I:%M%p") %>
              <% elsif favour.deadline.to_date == Date.tomorrow %>
                  Tomorrow at <%= favour.deadline.strftime("%I:%M%p") %>
              <% else %>
                  <%=favour.deadline.strftime("%d/%m/%Y at %I:%M%p")%>
              <% end %></td>

            <td><% if !current_user.lat.nil?  && !favour.latitude.nil? %>
                  <% Geocoder.configure( :units => :km ) %>
                  <%= favour.distance_from([current_user.lat, current_user.long]).round(2) %>
              <% else %>
                  -
              <% end %></td>

            <td><%= link_to favour.user.name, favour.user %></td>

            <td><%= favour.description %></td>
          </tr>
      <% end %>
      </tbody>

    </table>
<%end%>

<script>
  $(document).on('turbolinks:load', function(){
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(locateSuccess, locateFail);
    } else {
      alert("Your browser does not allow me to access your current location, sorry.");
    }

  })

  // Successful geolocation
  function locateSuccess(loc) {
    $.ajax({
      type: 'POST',
      url: '/store_location/',
      data: {lat: loc.coords.latitude, lng: loc.coords.longitude},
      dataType: 'json'
    }).done(function(data){
      console.log(data)
    });
  }


  // Unsuccessful geolocation
  function locateFail(geoPositionError) {
    switch (geoPositionError.code) {
      case 0: // UNKNOWN_ERROR
        alert('An unknown error occurred, sorry');
        break;
      case 1: // PERMISSION_DENIED
        alert('Permission to use Geolocation was denied, please use a different browser');
        break;
      case 2: // POSITION_UNAVAILABLE
        alert("Couldn't find you...");
        break;
      case 3: // TIMEOUT
        alert('The Geolocation request took too long and timed out');
        break;
      default:
    }
  }
</script>